{% extends "base.html.twig" %}

{% block content %}
<div class="min-h-screen bg-[#232323]">
    <main class="max-w-[1440px] mx-auto px-4 py-8">
        <!-- Quick Actions -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-white mb-4">Quick Actions</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <a href="/dashboard/tickets" class="bg-white/5 rounded-lg p-4 border border-white/10 hover:bg-white/10 transition-colors">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="ticket" class="h-6 w-6 text-blue-400"></i>
                        <div>
                            <h3 class="text-white font-semibold">Ticket Management</h3>
                            <p class="text-gray-400 text-sm">Create and manage support tickets</p>
                        </div>
                    </div>
                </a>

                <a href="/dashboard/tickets" class="bg-white/5 rounded-lg p-4 border border-white/10 hover:bg-white/10 transition-colors">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="settings" class="h-6 w-6 text-green-400"></i>
                        <div>
                            <h3 class="text-white font-semibold">Team Management</h3>
                            <p class="text-gray-400 text-sm">Assign tickets to team members</p>
                        </div>
                    </div>
                </a>

                <a href="/analytics" class="bg-white/5 rounded-lg p-4 border border-white/10 hover:bg-white/10 transition-colors">
                    <div class="flex items-center space-x-3">
                        <i data-lucide="bar-chart-3" class="h-6 w-6 text-purple-400"></i>
                        <div>
                            <h3 class="text-white font-semibold">Support Analytics</h3>
                            <p class="text-gray-400 text-sm">Track performance and trends</p>
                        </div>
                    </div>
                </a>
            </div>
        </div>

        <!-- Ticket Statistics -->
        <div class="mb-8">
            <h2 class="text-xl font-bold text-white mb-4">Ticket Statistics</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="bg-white/5 rounded-lg p-6 border border-white/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Total Tickets</p>
                            <p class="text-3xl font-bold text-white" id="totalTickets">0</p>
                            <p class="text-gray-400 text-xs mt-1">All time</p>
                        </div>
                        <i data-lucide="ticket" class="h-8 w-8 text-blue-400"></i>
                    </div>
                </div>

                <div class="bg-white/5 rounded-lg p-6 border border-white/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Open Tickets</p>
                            <p class="text-3xl font-bold text-white" id="openTickets">0</p>
                            <p class="text-gray-400 text-xs mt-1">Pending resolution</p>
                        </div>
                        <i data-lucide="settings" class="h-8 w-8 text-orange-400"></i>
                    </div>
                </div>

                <div class="bg-white/5 rounded-lg p-6 border border-white/10">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-400 text-sm">Resolved Tickets</p>
                            <p class="text-3xl font-bold text-white" id="closedTickets">0</p>
                            <p class="text-gray-400 text-xs mt-1">Successfully closed</p>
                        </div>
                        <i data-lucide="trending-up" class="h-8 w-8 text-green-400"></i>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Ticket Activity -->
        <div class="bg-white/5 rounded-lg p-6 border border-white/10">
            <h3 class="text-lg font-bold text-white mb-4">Recent Ticket Activity</h3>
            <div id="recentActivity" class="space-y-3">
                <p class="text-gray-400 text-sm">No recent activity</p>
            </div>
        </div>
    </main>
</div>

<script>
// Check for session on page load
const sessionData = localStorage.getItem('ticketapp_session');

if (!sessionData) {
    window.location.href = '/auth?mode=login';
} else {
    const session = JSON.parse(sessionData);
    
    // Load tickets from localStorage
    const tickets = JSON.parse(localStorage.getItem('tickets_' + session.user.id) || '[]');
    
    // Calculate stats
    const total = tickets.length;
    const open = tickets.filter(t => t.status === 'open').length;
    const inProgress = tickets.filter(t => t.status === 'in_progress').length;
    const closed = tickets.filter(t => t.status === 'closed').length;
    
    // Update stats
    document.getElementById('totalTickets').textContent = total;
    document.getElementById('openTickets').textContent = open;
    document.getElementById('closedTickets').textContent = closed;
    
    // Show recent activity
    const recentActivity = document.getElementById('recentActivity');
    if (tickets.length > 0) {
        const sortedTickets = tickets.sort((a, b) => new Date(b.updatedAt || b.createdAt || '').getTime() - new Date(a.updatedAt || a.createdAt || '').getTime());
        recentActivity.innerHTML = sortedTickets.slice(0, 4).map(ticket => {
            const statusColor = ticket.status === 'open' ? 'bg-red-400' : 
                               ticket.status === 'in_progress' ? 'bg-yellow-400' : 'bg-green-400';
            const statusText = ticket.status === 'open' ? 'New ticket' : 
                               ticket.status === 'in_progress' ? 'Ticket updated' : 'Ticket resolved';
            const timeAgo = formatTimeAgo(ticket.updatedAt || ticket.createdAt || Date.now());
            
            return `
                <div class="flex items-center justify-between p-3 bg-white/5 rounded-lg">
                    <div class="flex items-center space-x-3">
                        <div class="w-2 h-2 rounded-full ${statusColor}"></div>
                        <span class="text-white text-sm">${statusText} #${ticket.id} - "${ticket.title}"</span>
                    </div>
                    <span class="text-gray-400 text-xs">${timeAgo}</span>
                </div>
            `;
        }).join('');
    }
}

function formatTimeAgo(dateString) {
    const date = new Date(dateString);
    const now = new Date();
    const diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));
    
    if (diffInMinutes < 60) {
        return `${diffInMinutes} minutes ago`;
    } else if (diffInMinutes < 1440) {
        return `${Math.floor(diffInMinutes / 60)} hours ago`;
    } else {
        return `${Math.floor(diffInMinutes / 1440)} days ago`;
    }
}

// Initialize Lucide icons
lucide.createIcons();
</script>
{% endblock %}
